---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Hero from '../components/Hero.astro';
import ServiceCard from '../components/ServiceCard.astro';
import services from '../data/services.json';

// Group services by owner
const ownerOrder = ['Zuckerberg', 'Musk', 'Ek', 'Hastings', 'Bezos', 'Altman', 'Iger', 'Zaslav', 'Nadella', 'Roberts', 'Ellison', 'Zhang Yiming'];
const servicesByOwner = ownerOrder
  .map(owner => ({
    owner,
    services: services.filter(s => s.owner === owner)
  }))
  .filter(group => group.services.length > 0);
---

<BaseLayout title="Cut Them Off">
  <Header slot="header" />

  <Hero headline="Cut Them Off.">
    <p class="subtext">These billionaires bent the knee to Trump because they care about one thing: their bottom line.</p>
    <p class="subtext">Fine. We speak that language too.</p>
    <p class="subtext">Every subscription you cancel is money out of their pockets. Every account you delete makes shareholders nervous. Hit them where it hurtsâ€”it's the only thing they understand.</p>
  </Hero>

  <section class="goal-callout">
    <div class="goal-header">
      <span class="goal-icon">ðŸŽ¯</span>
      <span class="goal-label">THE GOAL:</span>
      <span class="goal-target">1,000 people by February 15</span>
    </div>
    <p class="goal-subtext">Can we get there? Make your plan below, then share with 3 friends.</p>
  </section>

  <section class="selector">
    <h2>Which companies will you cut off?</h2>
    <p class="selector-help">Select the ones you want to cancel. We'll show you how.</p>
    <div class="owner-groups">
      {servicesByOwner.map((group) => (
        <div class="owner-group">
          <h3 class="owner-name">{group.owner}</h3>
          <div class="owner-services">
            {group.services.map((service) => (
              <label class="service-checkbox">
                <input type="checkbox" value={service.id} data-price={service.monthlyPrice} data-owner={service.owner} />
                <span class="service-name">{service.name}</span>
                <span class="service-price">
                  {service.monthlyPrice > 0 ? `$${service.monthlyPrice.toFixed(2)}/mo` : ''}
                </span>
              </label>
            ))}
          </div>
        </div>
      ))}
    </div>
  </section>

  <section class="savings-section hidden">
    <p class="savings-highlight">Taking back <span id="annual-savings" class="amount">$0/year</span> from <span id="owner-count" class="owner-count">0 billionaires</span></p>
  </section>

  <section class="results">
    <p class="empty-state">Select services above to see how to cancel or delete them.</p>

    <div class="services-grid">
      {services.map((service) => (
        <ServiceCard {...service} />
      ))}
    </div>
  </section>

  <section class="share-section hidden">
    <h3 class="share-cta">Multiply your impact</h3>
    <p class="share-hint">If 10 friends join you, that's <span id="share-multiplied">$0</span> these companies won't see.</p>
    <div class="share-buttons">
      <a href="#" id="share-whatsapp" class="share-btn share-whatsapp" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        WhatsApp
      </a>
      <a href="#" id="share-sms" class="share-btn share-sms">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
        Text
      </a>
      <a href="#" id="share-email" class="share-btn share-email">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
        Email
      </a>
      <button type="button" id="share-signal" class="share-btn share-signal">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
        Signal
      </button>
      <button type="button" id="share-copy" class="share-btn share-copy">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
        Copy
      </button>
    </div>
    <span class="share-feedback hidden" id="share-feedback">Copied! Now paste in Signal or anywhere.</span>
    <p class="share-text hidden" id="share-text">I'm cutting off $0/year from companies supporting the current regime. If you join me, we multiply the impact. https://cutthemoff.vercel.app</p>
  </section>

  <Footer slot="footer" />
</BaseLayout>

<style>
  .subtext {
    font-size: 1.1rem;
    color: var(--muted);
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
  }

  .subtext.cta {
    margin-top: 1rem;
    font-size: 1.25rem;
    color: var(--text);
  }

  .facts {
    list-style: none;
    padding: 0;
    margin: 0;
    text-align: left;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
  }

  .facts li {
    padding: 0.75rem 0;
    padding-left: 2rem;
    position: relative;
    color: var(--muted);
  }

  .facts li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 8px;
    height: 8px;
    background: var(--accent);
    border-radius: 50%;
  }

  .goal-callout {
    border-top: 1px solid var(--border);
    padding: 1.25rem 0;
    text-align: center;
    margin-bottom: 0.5rem;
  }

  .goal-header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 0.35rem;
    margin-bottom: 0.25rem;
  }

  .goal-icon {
    font-size: 1rem;
  }

  .goal-label {
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--muted);
  }

  .goal-target {
    font-weight: 700;
    font-size: 0.95rem;
    color: var(--text);
  }

  .goal-subtext {
    margin: 0;
    color: var(--muted);
    font-size: 0.9rem;
  }

  .selector {
    padding: 1.5rem 0;
  }

  .selector h2 {
    text-align: center;
    margin-bottom: 0.5rem;
  }

  .selector-help {
    text-align: center;
    color: var(--muted);
    margin: 0 0 1.5rem 0;
    font-size: 0.95rem;
  }

  .owner-groups {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem 1rem;
  }

  .owner-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .owner-name {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text);
    margin: 0;
    padding-bottom: 0.25rem;
    border-bottom: 2px solid var(--accent);
  }

  .owner-services {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .service-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 0.75rem;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .service-checkbox:hover {
    border-color: var(--accent);
  }

  .service-checkbox input {
    width: 1.125rem;
    height: 1.125rem;
    accent-color: var(--accent);
    flex-shrink: 0;
  }

  .service-checkbox .service-name {
    flex: 1;
    font-weight: 500;
    font-size: 0.9rem;
  }

  .service-checkbox .service-price {
    font-size: 0.8rem;
    color: var(--muted);
  }

  .results {
    padding: 1rem 0;
  }

  .empty-state {
    text-align: center;
    color: var(--muted);
    padding: 2rem;
    background: var(--card-bg);
    border: 1px dashed var(--border);
    border-radius: 12px;
  }

  .empty-state.hidden {
    display: none;
  }

  .savings-section {
    text-align: center;
    padding: 1.5rem;
    background: var(--card-bg);
    border: 2px solid var(--success);
    border-radius: 12px;
    margin-bottom: 1.5rem;
  }

  .savings-section.hidden {
    display: none;
  }

  .savings-highlight {
    font-size: 1.25rem;
    color: var(--text);
    margin: 0;
  }

  .savings-highlight .amount {
    font-size: 2rem;
    font-weight: 700;
    color: var(--success);
  }

  .savings-highlight .owner-count {
    font-weight: 700;
    color: var(--text);
  }

  .share-section {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    text-align: center;
  }

  .share-section.hidden {
    display: none;
  }

  .share-cta {
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--text);
  }

  .share-hint {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
    color: var(--text);
  }

  .share-hint span {
    font-weight: 700;
    color: var(--success);
  }

  .share-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    margin-top: 1rem;
  }

  .share-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: transform 0.1s, opacity 0.2s;
  }

  .share-btn:hover {
    transform: scale(1.02);
    text-decoration: none;
  }

  .share-btn:active {
    transform: scale(0.98);
  }

  .share-btn svg {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
  }

  .share-whatsapp {
    background: #25D366;
    color: white;
  }

  .share-sms {
    background: #34C759;
    color: white;
  }

  .share-email {
    background: var(--accent);
    color: white;
  }

  .share-signal {
    background: #3A76F0;
    color: white;
  }

  .share-copy {
    background: var(--card-bg);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .share-text {
    position: absolute;
    left: -9999px;
  }

  .share-feedback {
    display: block;
    margin-top: 0.75rem;
    color: var(--success);
    font-weight: 500;
  }

  .share-feedback.hidden {
    display: none;
  }

  .services-grid {
    display: none;
    gap: 1rem;
  }

  .services-grid.active {
    display: grid;
  }

  @media (min-width: 640px) {
    .owner-groups {
      grid-template-columns: repeat(3, 1fr);
    }

    .services-grid.active {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .owner-groups {
      grid-template-columns: repeat(4, 1fr);
    }
  }
</style>

<script>
  const checkboxes = document.querySelectorAll<HTMLInputElement>('.service-checkbox input');
  const cards = document.querySelectorAll('.service-card');
  const grid = document.querySelector('.services-grid');
  const emptyState = document.querySelector('.empty-state');
  const savingsSection = document.querySelector('.savings-section');
  const shareSection = document.querySelector('.share-section');
  const shareTextEl = document.getElementById('share-text');
  const shareWhatsApp = document.getElementById('share-whatsapp');
  const shareSMS = document.getElementById('share-sms');
  const shareEmail = document.getElementById('share-email');
  const shareSignal = document.getElementById('share-signal');
  const shareCopy = document.getElementById('share-copy');
  const shareFeedback = document.getElementById('share-feedback');
  const shareMultipliedEl = document.getElementById('share-multiplied');

  function formatMoney(amount: number): string {
    return '$' + amount.toLocaleString('en-US');
  }

  function updateResults() {
    const selected = new Set<string>();
    const selectedOwners = new Set<string>();
    let totalMonthly = 0;

    checkboxes.forEach((cb) => {
      if (cb.checked) {
        selected.add(cb.value);
        totalMonthly += parseFloat(cb.dataset.price || '0');
        if (cb.dataset.owner) {
          selectedOwners.add(cb.dataset.owner);
        }
      }
    });

    const hasSelection = selected.size > 0;
    const annual = Math.round(totalMonthly * 12);
    const multiplied = annual * 10;
    const ownerCount = selectedOwners.size;

    // Toggle sections
    emptyState?.classList.toggle('hidden', hasSelection);
    savingsSection?.classList.toggle('hidden', !hasSelection || annual === 0);
    shareSection?.classList.toggle('hidden', !hasSelection);
    grid?.classList.toggle('active', hasSelection);

    // Update savings display and share text
    const annualSavingsEl = document.getElementById('annual-savings');
    const ownerCountEl = document.getElementById('owner-count');

    if (ownerCountEl) {
      ownerCountEl.textContent = `${ownerCount} billionaire${ownerCount === 1 ? '' : 's'}`;
    }

    if (annual > 0) {
      if (annualSavingsEl) annualSavingsEl.textContent = `${formatMoney(annual)}/year`;
      if (shareMultipliedEl) shareMultipliedEl.textContent = formatMoney(multiplied);
      if (shareTextEl) {
        shareTextEl.textContent = `I'm cutting off ${formatMoney(annual)}/year from ${ownerCount} billionaire${ownerCount === 1 ? '' : 's'}. If you join me, we multiply the impact. https://cutthemoff.vercel.app`;
      }
    } else {
      if (shareMultipliedEl) shareMultipliedEl.textContent = '$0';
      if (shareTextEl) {
        shareTextEl.textContent = `I'm cutting off ${ownerCount} billionaire${ownerCount === 1 ? '' : 's'}. If you join me, we multiply the impact. https://cutthemoff.vercel.app`;
      }
    }

    // Show/hide individual cards
    cards.forEach((card) => {
      const id = card.getAttribute('data-id');
      const isSelected = id ? selected.has(id) : false;
      (card as HTMLElement).style.display = isSelected ? 'flex' : 'none';
    });

    // Update share links with new text
    updateShareLinks();
  }

  checkboxes.forEach((cb) => {
    cb.addEventListener('change', updateResults);
  });

  // Hide all cards initially
  cards.forEach((card) => {
    (card as HTMLElement).style.display = 'none';
  });

  // Update share links when selections change
  function updateShareLinks() {
    const text = shareTextEl?.textContent || '';
    const encodedText = encodeURIComponent(text);
    const subject = encodeURIComponent('Cut Them Off - Join the strike');

    if (shareWhatsApp) {
      (shareWhatsApp as HTMLAnchorElement).href = `https://wa.me/?text=${encodedText}`;
    }
    if (shareSMS) {
      (shareSMS as HTMLAnchorElement).href = `sms:?&body=${encodedText}`;
    }
    if (shareEmail) {
      (shareEmail as HTMLAnchorElement).href = `mailto:?subject=${subject}&body=${encodedText}`;
    }
  }

  // Signal button - uses native share if available, otherwise copies
  shareSignal?.addEventListener('click', async () => {
    const text = shareTextEl?.textContent || '';
    if (navigator.share) {
      try {
        await navigator.share({ text, url: 'https://cutthemoff.vercel.app' });
      } catch (err) {
        // User cancelled
      }
    } else {
      await copyToClipboard(text);
    }
  });

  // Copy button
  shareCopy?.addEventListener('click', async () => {
    const text = shareTextEl?.textContent || '';
    await copyToClipboard(text);
  });

  async function copyToClipboard(text: string) {
    try {
      await navigator.clipboard.writeText(text);
      shareFeedback?.classList.remove('hidden');
      setTimeout(() => {
        shareFeedback?.classList.add('hidden');
      }, 3000);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  }
</script>
